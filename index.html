<!DOCTYPE html>
<html lang="pt-PT">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MasterClass • Editor (com tutorial guiado)</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow:wght@800&family=Work+Sans:wght@300;400&display=swap" rel="stylesheet">
<style>
  html,body{margin:0;background:#0f0f0f;color:#eee;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Work Sans',sans-serif}
  .app{display:grid;grid-template-columns:1fr 460px;gap:20px;max-width:min(1680px,96vw);margin:20px auto}
  .stage{background:#1a1a1a;border-radius:14px;padding:12px;display:flex;align-items:center;justify-content:center}
  canvas{width:100%;height:auto;background:transparent;border-radius:10px}
  .panel{background:#141414;border:1px solid #2a2a2a;border-radius:14px;padding:14px;display:flex;flex-direction:column;gap:12px}
  .row{display:flex;flex-direction:column;gap:6px}
  .lbl{position:relative;display:flex;align-items:center;gap:6px}
  label{font-size:13px;color:#bbb}
  input[type="text"], textarea{background:#0f0f0f;border:1px solid #333;border-radius:10px;color:#f2f2f2;padding:10px 12px;font-size:14px}
  textarea{min-height:80px;resize:vertical;white-space:pre-wrap}
  input[type="range"]{width:100%}
  select, input[type="color"]{background:#0f0f0f;border:1px solid #333;border-radius:10px;color:#f2f2f2;padding:8px 10px}
  button{background:#ff6f4f;border:0;color:#fff;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .muted{color:#99a}
  /* Tooltip */
  .info{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:50%;background:#22314a;color:#9fd;cursor:pointer;font-size:12px;font-weight:800;user-select:none}
  .info::after{content:attr(data-tip);position:absolute;left:50%;transform:translateX(-50%) translateY(8px);bottom:-4px;min-width:180px;max-width:280px;padding:8px 10px;border-radius:10px;background:#101826;border:1px solid #2a3b57;color:#cfe8ff;font-size:12px;line-height:1.25;box-shadow:0 10px 24px rgba(0,0,0,.35);opacity:0;pointer-events:none;transition:opacity .15s ease, transform .15s ease;white-space:normal;z-index:30}
  .info:hover::after, .info.active::after{opacity:1;transform:translateX(-50%) translateY(12px)}
  /* Tutorial overlay */
  .tour-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:saturate(0.8) blur(1px);z-index:80;display:none}
  .tour-highlight{position:fixed;border:2px solid #7fd0ff;border-radius:12px;box-shadow:0 0 0 200vmax rgba(0,0,0,.55);z-index:90;pointer-events:none;display:none;transition:all .25s ease}
  .tour-card{position:fixed;z-index:95;display:none;max-width:min(420px,90vw);background:#0f1624;border:1px solid #274069;border-radius:14px;color:#e9f2ff;padding:14px;box-shadow:0 14px 42px rgba(0,0,0,.5)}
  .tour-card h3{margin:0 0 8px 0;font-size:18px}
  .tour-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
  .btn{background:#2b4775;border:0;color:#fff;padding:8px 12px;border-radius:10px;cursor:pointer}
  .btn.primary{background:#ff6f4f}
  .btn.ghost{background:transparent;border:1px solid #3c557f;color:#cfe8ff}
  .tour-start{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:70}
  .tour-start .modal{background:#0f1624;border:1px solid #274069;border-radius:14px;padding:18px 16px;max-width:520px;width:90%;color:#e9f2ff;box-shadow:0 14px 42px rgba(0,0,0,.5)}
  .pulse{animation:pulse 1.2s ease-in-out infinite}
  @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(127,208,255,.7)}100%{box-shadow:0 0 0 12px rgba(127,208,255,0)}}
</style>
</head>
<body>
  <div class="app">
    <div class="stage" id="stage">
      <canvas id="c" width="1434" height="700" aria-label="pré‑visualização"></canvas>
    </div>
    <div class="panel" id="panel">
      <div class="row" id="grp-layout">
        <div class="lbl">
          <label>Layout</label>
          <span class="info" data-tip="Escolhe a cor da pílula e o lado onde queres a fotografia (direita/esquerda). A forma e o texto ‘MasterClass’ são gerados automaticamente.">i</span>
        </div>
        <div class="grid2">
          <div class="lbl" style="gap:10px"><input id="bgColor" type="color" value="#f37759" /><small class="muted">Cor</small></div>
          <select id="orientation">
            <option value="right" selected>Fotografia à direita</option>
            <option value="left">Fotografia à esquerda</option>
          </select>
        </div>
        <div class="grid2">
          <select id="mcPos">
            <option value="left">“MasterClass” canto superior esquerdo</option>
            <option value="right">“MasterClass” canto superior direito</option>
          </select>
          <span class="muted"></span>
        </div>
      </div>

      <div class="row" id="grp-photo">
        <div class="lbl">
          <label>Fotografia do especialista</label>
          <span class="info" data-tip="Carrega a foto e usa os controlos para a posicionar e escalar dentro do recorte circular.">i</span>
        </div>
        <input id="photo" type="file" accept="image/*" />
        <div class="grid2">
          <div class="row"><div class="lbl"><label>Escala da foto</label><span class="info" data-tip="Aumenta/diminui o tamanho da foto.">i</span></div><input id="scale" type="range" min="0.2" max="3" step="0.01" value="1" /></div>
          <div class="row"><div class="lbl"><label>Foto — horizontal (esquerda/direita)</label><span class="info" data-tip="Move a foto horizontalmente dentro do recorte circular.">i</span></div><input id="posX" type="range" min="-1500" max="1500" step="1" value="0" /></div>
          <div class="row"><div class="lbl"><label>Foto — vertical (cima/baixo)</label><span class="info" data-tip="Move a foto verticalmente dentro do recorte circular.">i</span></div><input id="posY" type="range" min="-1500" max="1500" step="1" value="0" /></div>
        </div>
      </div>

      <div class="row" id="grp-circle">
        <div class="lbl">
          <label>Recorte circular (CX/CY/R)</label>
          <span class="info" data-tip="Centro X (horizontal), Centro Y (vertical) e Raio do círculo. Ajusta para encaixar a foto.">i</span>
        </div>
        <div class="grid2">
          <div class="row"><label>Centro horizontal</label><input id="cx" type="range" min="0" max="2000" step="1" value="1060" /></div>
          <div class="row"><label>Centro vertical</label><input id="cy" type="range" min="0" max="1200" step="1" value="350" /></div>
          <div class="row"><label>Raio</label><input id="cr" type="range" min="10" max="1200" step="1" value="300" /></div>
        </div>
      </div>

      <div class="row" id="grp-name">
        <div class="lbl">
          <label>Nome (linha 1)</label><span class="info" data-tip="Primeira linha do título (Barlow ExtraBold — MAIÚSCULAS).">i</span>
        </div>
        <input id="nome" type="text" value="NAIARA" />
      </div>
      <div class="row" id="grp-surname">
        <div class="lbl">
          <label>Sobrenome (linha 2)</label><span class="info" data-tip="Segunda linha do título, logo abaixo do nome.">i</span>
        </div>
        <input id="sobrenome" type="text" value="BACK" />
      </div>

      <div class="grid2" id="grp-titlepos">
        <div class="row">
          <div class="lbl">
            <label>Título — horizontal (esquerda/direita) <small class="muted" id="txLabel">• usa margem esquerda / direita conforme o lado</small></label>
            <span class="info" data-tip="Move o título na horizontal. Quando a pílula está à ESQUERDA, este slider funciona como MARGEM DIREITA.">i</span>
          </div>
          <input id="titleX" type="range" min="0" max="2000" step="1" value="110" />
        </div>
        <div class="row">
          <div class="lbl">
            <label>Título — vertical (cima/baixo)</label><span class="info" data-tip="Move o título na vertical (topo da 1.ª linha).">i</span>
          </div>
          <input id="titleY" type="range" min="0" max="1200" step="1" value="310" />
        </div>
      </div>
      <div class="row" id="grp-titlesize">
        <div class="lbl">
          <label>Tamanho do título</label><span class="info" data-tip="Controla o tamanho do título. Não há auto‑ajuste; se invadir a área, reduz manualmente.">i</span>
        </div>
        <input id="titleSize" type="range" min="80" max="360" step="1" value="208" />
      </div>

      <div class="row" id="grp-bio">
        <div class="lbl">
          <label>Bio</label><span class="info" data-tip="Texto em Work Sans Light. ENTER faz nova linha. Nunca invade o círculo da foto.">i</span>
        </div>
        <textarea id="bio">Formada em Publicidade e Propaganda, com MBA em Marketing Digital e Mestrado em Ciências da Comunicação.</textarea>
      </div>
      <div class="grid2" id="grp-biopos">
        <div class="row">
          <div class="lbl">
            <label>Bio — horizontal (esquerda/direita) <small class="muted" id="bxLabel">• usa margem esquerda / direita conforme o lado</small></label>
            <span class="info" data-tip="Move a bio na horizontal. Quando a pílula está à ESQUERDA, este slider funciona como MARGEM DIREITA.">i</span>
          </div>
          <input id="bioX" type="range" min="0" max="2000" step="1" value="110" />
        </div>
        <div class="row">
          <div class="lbl">
            <label>Bio — vertical (cima/baixo)</label><span class="info" data-tip="Move a bio na vertical (linha superior).">i</span>
          </div>
          <input id="bioY" type="range" min="0" max="2000" step="1" value="560" />
        </div>
      </div>

      <div class="row" id="grp-export">
        <button id="export">Exportar imagem</button>
        <span id="status" class="muted"></span>
      </div>
    </div>
  </div>

  <!-- Tutorial UI -->
  <div class="tour-start" id="tourStart">
    <div class="modal">
      <h3>Queres um tutorial rápido?</h3>
      <p>Posso guiar-te passo a passo (2–3 minutos) pelos controlos essenciais até à exportação.</p>
      <div class="tour-actions">
        <button class="btn ghost" id="skipTour">Ignorar</button>
        <button class="btn primary" id="startTour">Iniciar tutorial</button>
      </div>
    </div>
  </div>
  <div class="tour-backdrop" id="tourBackdrop"></div>
  <div class="tour-highlight" id="tourHighlight"></div>
  <div class="tour-card" id="tourCard">
    <h3 id="tourTitle">Tutorial</h3>
    <div id="tourText" style="font-size:14px;line-height:1.45"></div>
    <div class="tour-actions">
      <button class="btn ghost" id="tourExit">Sair</button>
      <button class="btn" id="tourPrev">Anterior</button>
      <button class="btn primary" id="tourNext">Seguinte</button>
    </div>
  </div>

<script>
  // Tooltips toggle
  document.addEventListener('click', (e)=>{
    const isInfo = e.target.classList && e.target.classList.contains('info');
    document.querySelectorAll('.info.active').forEach(el=>{ if(el!==e.target) el.classList.remove('active'); });
    if(isInfo){ e.target.classList.toggle('active'); }
  });

  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d');

  const bgColor = document.getElementById('bgColor');
  const orientationSel = document.getElementById('orientation');
  const mcPos   = document.getElementById('mcPos');

  const photoInput = document.getElementById('photo');
  const scaleInput = document.getElementById('scale');
  const posXInput  = document.getElementById('posX');
  const posYInput  = document.getElementById('posY');

  const cxInput = document.getElementById('cx');
  const cyInput = document.getElementById('cy');
  const crInput = document.getElementById('cr');

  const nomeInput = document.getElementById('nome');
  const sobrenomeInput = document.getElementById('sobrenome');
  const titleXInput = document.getElementById('titleX');
  const titleYInput = document.getElementById('titleY');
  const titleSizeInput = document.getElementById('titleSize');

  const bioInput = document.getElementById('bio');
  const bioXInput = document.getElementById('bioX');
  const bioYInput = document.getElementById('bioY');

  const statusEl  = document.getElementById('status');

  const pt = v => v * (96/72);
  let NAME_PX = pt(208), TRACK = pt(6), BIO_PX = pt(20.8), BIO_LH = Math.round(pt(20.8)*1.45);

  function recomputeType(){
    const s = canvas.height / 700;
    NAME_PX = pt(+titleSizeInput.value) * s;
    TRACK   = pt(6) * s;
    BIO_PX  = pt(20.8) * s;
    BIO_LH  = Math.round(BIO_PX * 1.45);
  }

  let photo = null, photoURL = null;

  function drawPill(color, side){
    const W = canvas.width, H = canvas.height;
    const R = H/2;
    ctx.save();
    ctx.clearRect(0,0,W,H);
    ctx.beginPath();
    if(side === 'right'){
      ctx.moveTo(0,0);
      ctx.lineTo(W-R,0);
      ctx.arc(W-R, R, R, -Math.PI/2, Math.PI/2, false);
      ctx.lineTo(0,H);
    } else {
      ctx.moveTo(R,0);
      ctx.lineTo(W,0);
      ctx.lineTo(W,H);
      ctx.lineTo(R,H);
      ctx.arc(R, R, R, Math.PI/2, -Math.PI/2, false);
    }
    ctx.closePath();
    ctx.fillStyle = color;
    ctx.fill();
    ctx.restore();
  }
  function drawMasterClass(){
    const W = canvas.width;
    ctx.save();
    ctx.fillStyle = '#fff';
    ctx.font = `800 ${Math.round(52 * (canvas.height/700))}px 'Barlow', sans-serif`;
    ctx.textBaseline = 'top';
    const pad = Math.round(48 * (canvas.height/700));
    const text = "MasterClass";
    const m = ctx.measureText(text);
    if(mcPos.value === 'right'){
      ctx.fillText(text, W - pad - m.width, pad);
    }else{
      ctx.fillText(text, pad, pad);
    }
    ctx.restore();
  }
  function drawTracked(text, x, y, sizePx, trackingPx){
    ctx.font = `800 ${sizePx}px 'Barlow', sans-serif`;
    ctx.fillStyle = '#fff'; ctx.textBaseline = 'alphabetic';
    let cursor = x;
    for(const ch of (text||'')){
      const m = ctx.measureText(ch);
      ctx.fillText(ch, cursor, y);
      cursor += m.width + trackingPx;
    }
  }
  function trackedWidth(text, sizePx, trackingPx){
    ctx.font = `800 ${sizePx}px 'Barlow', sans-serif`;
    let w=0; for(const ch of (text||'')){ w += ctx.measureText(ch).width + trackingPx; } return w;
  }
  function wrapLeft(text, x, y, maxW, lh){
    ctx.font = `300 ${BIO_PX}px 'Work Sans', sans-serif`;
    ctx.fillStyle = '#fff'; ctx.textBaseline = 'top';
    const paras = String(text||'').split('\n');
    for(const p of paras){
      const words = p.split(' '); let line='';
      for(let i=0;i<words.length;i++){
        const tl = line + words[i] + ' ';
        if(ctx.measureText(tl).width > maxW && i>0){ ctx.fillText(line,x,y); line=words[i]+' '; y+=lh; }
        else { line = tl; }
      }
      ctx.fillText(line, x, y); y += lh;
    }
  }
  function wrapRight(text, rightEdge, y, maxW, lh){
    ctx.font = `300 ${BIO_PX}px 'Work Sans', sans-serif`;
    ctx.fillStyle = '#fff'; ctx.textBaseline = 'top';
    const paras = String(text||'').split('\n');
    for(const p of paras){
      const words = p.split(' '); let line=''; let lines=[];
      for(let i=0;i<words.length;i++){
        const tl = line + words[i] + ' ';
        if(ctx.measureText(tl).width > maxW && i>0){ lines.push(line); line=words[i]+' '; }
        else { line = tl; }
      }
      lines.push(line);
      for(const L of lines){
        const w = ctx.measureText(L).width;
        const x = Math.max(rightEdge - w, 0);
        ctx.fillText(L, x, y);
        y += lh;
      }
    }
  }

  function margin(){ return Math.round(30 * (canvas.height/700)); }

  function computeTitlePositions(size, track){
    const side = orientationSel.value;
    const m = margin();
    if(side === 'right'){
      return { x: +titleXInput.value, align: 'left' };
    } else {
      const rightEdge = canvas.width - m - +titleXInput.value;
      const nomeW = trackedWidth((nomeInput.value||'').toUpperCase(), size, track);
      const sobrenomeW = trackedWidth((sobrenomeInput.value||'').toUpperCase(), size, track);
      return { x1: rightEdge - nomeW, x2: rightEdge - sobrenomeW, align: 'right', rightEdge };
    }
  }

  function bioMetrics(){
    const side = orientationSel.value;
    const m = margin();
    const cx = +cxInput.value, r = +crInput.value;
    if(side === 'right'){
      const maxW = Math.max(0, (cx - r) - m - +bioXInput.value);
      return {maxW, startX: +bioXInput.value, rightEdge: null};
    } else {
      const leftLimit  = cx + r + m;
      const rightEdge  = canvas.width - m - +bioXInput.value;
      const maxW       = Math.max(0, rightEdge - leftLimit);
      return {maxW, startX: leftLimit, rightEdge};
    }
  }

  function applyOrientationDefaults(){
    const side = orientationSel.value;
    const W = canvas.width, H = canvas.height, R = H/2;
    if(side === 'right'){
      cxInput.value = Math.round(W - R*0.7);
      cyInput.value = Math.round(H*0.5);
      crInput.value = Math.round(H*0.43);
      titleXInput.value = Math.round(110 * (H/700));
      titleYInput.value = Math.round(310 * (H/700));
      bioXInput.value = titleXInput.value;
      bioYInput.value = Math.round(560 * (H/700));
      mcPos.value = 'left';
    } else {
      cxInput.value = Math.round(R*0.7);
      cyInput.value = Math.round(H*0.5);
      crInput.value = Math.round(H*0.43);
      titleXInput.value = Math.round(60 * (H/700));
      titleYInput.value = Math.round(310 * (H/700));
      bioXInput.value = Math.round(60 * (H/700));
      bioYInput.value = Math.round(560 * (H/700));
      mcPos.value = 'right';
    }
  }

  function render(){
    const W = canvas.width, H = canvas.height;
    ctx.clearRect(0,0,W,H);
    const side = orientationSel.value;

    const s = H/700;
    NAME_PX = (96/72) * (+titleSizeInput.value) * s;
    TRACK   = (96/72) * 6 * s;
    BIO_PX  = (96/72) * 20.8 * s;
    BIO_LH  = Math.round(BIO_PX * 1.45);

    drawPill(bgColor.value, side);
    drawMasterClass();

    if(photo){
      const cx=+cxInput.value, cy=+cyInput.value, r=+crInput.value;
      const scale = +scaleInput.value, dx=+posXInput.value, dy=+posYInput.value;
      ctx.save(); ctx.beginPath(); ctx.arc(cx,cy,r-1,0,Math.PI*2); ctx.clip();
      const pw=photo.naturalWidth, ph=photo.naturalHeight;
      const base = Math.max((2*r)/pw,(2*r)/ph) * scale;
      const w=pw*base, h=ph*base;
      ctx.drawImage(photo, cx - w/2 + dx, cy - h/2 + dy, w, h);
      ctx.restore();
    }

    const size = NAME_PX, track = TRACK;
    const topY = +titleYInput.value;
    const pos = computeTitlePositions(size, track);
    if(pos.align === 'left'){
      drawTracked((nomeInput.value||'').toUpperCase(), pos.x, topY, size, track);
      drawTracked((sobrenomeInput.value||'').toUpperCase(), pos.x, topY + size*1.08, size, track);
    } else {
      drawTracked((nomeInput.value||'').toUpperCase(), pos.x1, topY, size, track);
      drawTracked((sobrenomeInput.value||'').toUpperCase(), pos.x2, topY + size*1.08, size, track);
    }

    const bm = bioMetrics();
    if(side === 'right'){
      wrapLeft(bioInput.value, bm.startX, +bioYInput.value, bm.maxW, BIO_LH);
    } else {
      wrapRight(bioInput.value, bm.rightEdge, +bioYInput.value, bm.maxW, BIO_LH);
    }

    statusEl.textContent = `${W}×${H} • orientação: ${side}`;
  }

  photoInput.addEventListener('change', e=>{
    const f=e.target.files?.[0]; if(!f) return;
    if(photoURL) URL.revokeObjectURL(photoURL);
    photoURL = URL.createObjectURL(f);
    const img=new Image(); img.onload=()=>{ photo=img; render(); }; img.src=photoURL;
  });

  [bgColor, orientationSel, mcPos, scaleInput, posXInput, posYInput, cxInput, cyInput, crInput,
   nomeInput, sobrenomeInput, titleXInput, titleYInput, titleSizeInput, bioInput, bioXInput, bioYInput]
   .forEach(el=>el.addEventListener('input', render));

  orientationSel.addEventListener('change', ()=>{ applyOrientationDefaults(); render(); });

  document.getElementById('export').addEventListener('click', ()=>{
    const a=document.createElement('a');
    const file=`masterclass_${(nomeInput.value+'_'+sobrenomeInput.value).toLowerCase().replace(/[^a-z0-9]+/g,'_')}.png`;
    if(canvas.toBlob){
      canvas.toBlob(b=>{ const url=URL.createObjectURL(b); a.href=url; a.download=file; a.click(); setTimeout(()=>URL.revokeObjectURL(url),1000); }, 'image/png');
    } else { a.href=canvas.toDataURL('image/png'); a.download=file; a.click(); }
  });

  applyOrientationDefaults();
  render();

  /* ===== Tutorial ===== */
  const tourStart = document.getElementById('tourStart');
  const tourBackdrop = document.getElementById('tourBackdrop');
  const tourHighlight = document.getElementById('tourHighlight');
  const tourCard = document.getElementById('tourCard');
  const tourTitle = document.getElementById('tourTitle');
  const tourText = document.getElementById('tourText');
  const btnPrev = document.getElementById('tourPrev');
  const btnNext = document.getElementById('tourNext');
  const btnExit = document.getElementById('tourExit');
  document.getElementById('startTour').onclick = ()=>{ tourStart.style.display='none'; startTour(); };
  document.getElementById('skipTour').onclick  = ()=>{ tourStart.style.display='none'; };

  const steps = [
    {el:'#grp-layout', title:'Escolher layout', text:'Seleciona a <b>cor</b> e o <b>lado</b> onde queres a fotografia. O MasterClass fica sempre a branco.', pos:'right'},
    {el:'#grp-photo', title:'Carregar fotografia', text:'Carrega a foto do/a especialista e usa <b>escala</b> + <b>horizontal/vertical</b> para enquadrar.', pos:'right'},
    {el:'#grp-circle', title:'Ajustar o recorte', text:'Se precisares, afina o <b>centro</b> e o <b>raio</b> do círculo para encaixar mesmo no sítio.', pos:'right'},
    {el:'#grp-name', title:'Escrever o nome', text:'Linha 1 do título (MAIÚSCULAS).', pos:'right'},
    {el:'#grp-surname', title:'Escrever o sobrenome', text:'Linha 2 do título (logo abaixo).', pos:'right'},
    {el:'#grp-titlepos', title:'Posicionar o título', text:'Define as posições <b>horizontal</b> e <b>vertical</b>. O slider horizontal vira <b>margem direita</b> quando a pílula está à esquerda.', pos:'right'},
    {el:'#grp-titlesize', title:'Tamanho do título', text:'Controla o tamanho. Não há auto‑ajuste — se invadir, reduz manualmente.', pos:'right'},
    {el:'#grp-bio', title:'Escrever a bio', text:'A bio aceita ENTER para novas linhas e nunca invade o círculo.', pos:'right'},
    {el:'#grp-biopos', title:'Posicionar a bio', text:'Move a bio na horizontal/vertical. Se a pílula estiver à esquerda, a horizontal funciona como margem direita.', pos:'right'},
    {el:'#grp-export', title:'Exportar', text:'Clica em <b>Exportar imagem</b> para gerar o PNG pronto a publicar.', pos:'top'}
  ];
  let step = 0;

  function startTour(){
    tourBackdrop.style.display='block';
    tourHighlight.style.display='block';
    tourCard.style.display='block';
    showStep(0);
  }
  btnExit.onclick = endTour;
  btnPrev.onclick = ()=> showStep(step-1);
  btnNext.onclick = ()=> showStep(step+1);

  function endTour(){
    tourBackdrop.style.display='none';
    tourHighlight.style.display='none';
    tourCard.style.display='none';
    document.querySelectorAll('.pulse').forEach(e=>e.classList.remove('pulse'));
  }

  function showStep(i){
    if(i<0){ i=0; }
    if(i>=steps.length){
      tourTitle.textContent='Tudo pronto!';
      tourText.innerHTML='Agora é só experimentar e quando quiseres podes voltar a este tutorial com o atalho <b>T</b>.';
      btnPrev.style.display='inline-block';
      btnNext.textContent='Recomeçar';
      btnNext.onclick = ()=> showStep(0);
      positionCardCenter();
      return;
    }
    step = i;
    const s = steps[step];
    const target = document.querySelector(s.el);
    if(!target){ return endTour(); }
    target.scrollIntoView({behavior:'smooth', block:'center'});
    document.querySelectorAll('.pulse').forEach(e=>e.classList.remove('pulse'));
    target.classList.add('pulse');

    const r = target.getBoundingClientRect();
    const pad = 8;
    tourHighlight.style.display='block';
    tourHighlight.style.left = (r.left-pad)+'px';
    tourHighlight.style.top  = (r.top-pad)+'px';
    tourHighlight.style.width  = (r.width+pad*2)+'px';
    tourHighlight.style.height = (r.height+pad*2)+'px';

    tourTitle.textContent = s.title;
    tourText.innerHTML = s.text;
    btnPrev.style.display = (step===0)?'none':'inline-block';
    btnNext.textContent = (step===steps.length-1)?'Concluir':'Seguinte';
    btnNext.onclick = ()=> showStep(step+1);

    // posicionar card
    const cardW = Math.min(420, window.innerWidth*0.9);
    let x = r.right + 16;
    let y = r.top;
    if(s.pos==='top'){ x = r.left; y = Math.max(16, r.top - 120); }
    if(x + cardW > window.innerWidth - 16){ x = window.innerWidth - cardW - 16; }
    if(y + 160 > window.innerHeight - 16){ y = window.innerHeight - 176; }
    tourCard.style.left = x+'px';
    tourCard.style.top  = y+'px';
  }

  function positionCardCenter(){
    const cardW = Math.min(420, window.innerWidth*0.9);
    tourCard.style.left = (window.innerWidth/2 - cardW/2)+'px';
    tourCard.style.top  = (window.innerHeight/2 - 100)+'px';
  }

  // atalho para relançar tutorial
  document.addEventListener('keydown', (e)=>{
    if(e.key.toLowerCase()==='t'){ startTour(); }
    if(e.key==='Escape'){ endTour(); }
  });
</script>
</body>
</html>

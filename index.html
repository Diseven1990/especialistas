<!DOCTYPE html>
<html lang="pt-PT">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MasterClass • Editor (cor + posições independentes)</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow:wght@800&family=Work+Sans:wght@300;400&display=swap" rel="stylesheet">
<style>
  html,body{margin:0;background:#0f0f0f;color:#eee;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Work Sans',sans-serif}
  .app{display:grid;grid-template-columns:1fr 420px;gap:20px;max-width:min(1680px,96vw);margin:20px auto}
  .stage{background:#1a1a1a;border-radius:14px;padding:12px;display:flex;align-items:center;justify-content:center}
  canvas{width:100%;height:auto;background:transparent;border-radius:10px}
  .panel{background:#141414;border:1px solid #2a2a2a;border-radius:14px;padding:14px;display:flex;flex-direction:column;gap:12px}
  .row{display:flex;flex-direction:column;gap:6px}
  label{font-size:13px;color:#bbb}
  input[type="text"], textarea{background:#0f0f0f;border:1px solid #333;border-radius:10px;color:#f2f2f2;padding:10px 12px;font-size:14px}
  textarea{min-height:80px;resize:vertical;white-space:pre-wrap}
  input[type="range"]{width:100%}
  select, input[type="color"]{background:#0f0f0f;border:1px solid #333;border-radius:10px;color:#f2f2f2;padding:8px 10px}
  button{background:#ff6f4f;border:0;color:#fff;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .muted{color:#99a}
</style>
</head>
<body>
  <div class="app">
    <div class="stage">
      <canvas id="c" width="1434" height="700" aria-label="pré‑visualização"></canvas>
    </div>
    <div class="panel">
      <div class="row">
        <label>Cor do layout</label>
        <div class="grid2">
          <input id="bgColor" type="color" value="#f37759" />
          <select id="mcPos">
            <option value="left">“MasterClass” canto superior esquerdo</option>
            <option value="right">“MasterClass” canto superior direito</option>
          </select>
        </div>
        <span class="muted">Não precisas de PNG: a forma é desenhada automaticamente. A palavra “MasterClass” fica a branco.</span>
      </div>

      <div class="row">
        <label>Fotografia do especialista</label>
        <input id="photo" type="file" accept="image/*" />
        <div class="grid2">
          <div class="row"><label>Escala da foto</label><input id="scale" type="range" min="0.2" max="3" step="0.01" value="1" /></div>
          <div class="row"><label>Posição X</label><input id="posX" type="range" min="-1500" max="1500" step="1" value="0" /></div>
          <div class="row"><label>Posição Y</label><input id="posY" type="range" min="-1500" max="1500" step="1" value="0" /></div>
        </div>
      </div>

      <div class="row">
        <label>Círculo da foto (CX/CY/R)</label>
        <div class="grid2">
          <div class="row"><label>CX</label><input id="cx" type="range" min="0" max="2000" step="1" value="1060" /></div>
          <div class="row"><label>CY</label><input id="cy" type="range" min="0" max="1200" step="1" value="350" /></div>
          <div class="row"><label>R</label><input id="cr" type="range" min="10" max="1200" step="1" value="300" /></div>
        </div>
      </div>

      <div class="row">
        <label>Nome (linha 1)</label>
        <input id="nome" type="text" value="NAIARA" />
      </div>
      <div class="row">
        <label>Sobrenome (linha 2)</label>
        <input id="sobrenome" type="text" value="BACK" />
      </div>
      <div class="grid2">
        <div class="row"><label>Título X</label><input id="titleX" type="range" min="0" max="2000" step="1" value="110" /></div>
        <div class="row"><label>Título Y (topo da 1.ª linha)</label><input id="titleY" type="range" min="0" max="1200" step="1" value="310" /></div>
      </div>

      <div class="row">
        <label>Bio (ENTER = nova linha)</label>
        <textarea id="bio">Formada em Publicidade e Propaganda, com MBA em Marketing Digital e Mestrado em Ciências da Comunicação.</textarea>
      </div>
      <div class="grid2">
        <div class="row"><label>Bio X</label><input id="bioX" type="range" min="0" max="2000" step="1" value="110" /></div>
        <div class="row"><label>Bio Y</label><input id="bioY" type="range" min="0" max="2000" step="1" value="560" /></div>
      </div>

      <div class="row">
        <button id="export">Exportar imagem</button>
        <span id="status" class="muted"></span>
      </div>
    </div>
  </div>

<script>
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d');

  // UI refs
  const bgColor = document.getElementById('bgColor');
  const mcPos   = document.getElementById('mcPos');

  const photoInput = document.getElementById('photo');
  const scaleInput = document.getElementById('scale');
  const posXInput  = document.getElementById('posX');
  const posYInput  = document.getElementById('posY');

  const cxInput = document.getElementById('cx');
  const cyInput = document.getElementById('cy');
  const crInput = document.getElementById('cr');

  const nomeInput = document.getElementById('nome');
  const sobrenomeInput = document.getElementById('sobrenome');
  const titleXInput = document.getElementById('titleX');
  const titleYInput = document.getElementById('titleY');

  const bioInput = document.getElementById('bio');
  const bioXInput = document.getElementById('bioX');
  const bioYInput = document.getElementById('bioY');

  const exportBtn = document.getElementById('export');
  const statusEl  = document.getElementById('status');

  // Tipografia
  const pt = v => v * (96/72);
  function recomputeType(){
    const s = canvas.height / 700;
    NAME_PX = pt(208.11) * s;          // tamanho do título (duas linhas iguais)
    TRACK   = pt(6) * s;               // tracking largo
    BIO_PX  = pt(20.8) * s;            // base da bio
    BIO_LH  = Math.round(BIO_PX * 1.45);
  }
  let NAME_PX = pt(208.11), TRACK = pt(6), BIO_PX = pt(20.8), BIO_LH = Math.round(pt(20.8)*1.45);
  recomputeType();

  // Foto
  let photo = null, photoURL = null;

  // Helpers
  function drawPill(color){
    const W = canvas.width, H = canvas.height;
    const R = H/2;
    ctx.save();
    // fundo transparente fora da forma
    ctx.clearRect(0,0,W,H);
    ctx.beginPath();
    ctx.moveTo(0,0);
    ctx.lineTo(W-R,0);
    ctx.arc(W-R, R, R, -Math.PI/2, Math.PI/2, false);
    ctx.lineTo(0,H);
    ctx.closePath();
    ctx.fillStyle = color;
    ctx.fill();
    ctx.restore();
  }
  function drawMasterClass(){
    const W = canvas.width;
    ctx.save();
    ctx.fillStyle = '#fff';
    ctx.font = `800 ${Math.round(52 * (canvas.height/700))}px 'Barlow', sans-serif`;
    ctx.textBaseline = 'top';
    const pad = Math.round(48 * (canvas.height/700));
    const text = "MasterClass";
    const m = ctx.measureText(text);
    if(mcPos.value === 'right'){
      ctx.fillText(text, W - pad - m.width, pad);
    }else{
      ctx.fillText(text, pad, pad);
    }
    ctx.restore();
  }
  function drawTracked(text, x, y, sizePx, trackingPx){
    ctx.font = `800 ${sizePx}px 'Barlow', sans-serif`;
    ctx.fillStyle = '#fff'; ctx.textBaseline = 'alphabetic';
    let cursor = x;
    for(const ch of (text||'')){
      const m = ctx.measureText(ch);
      ctx.fillText(ch, cursor, y);
      cursor += m.width + trackingPx;
    }
  }
  function trackedWidth(text, sizePx, trackingPx){
    ctx.font = `800 ${sizePx}px 'Barlow', sans-serif`;
    let w=0; for(const ch of (text||'')){ w += ctx.measureText(ch).width + trackingPx; } return w;
  }
  function wrap(text, x, y, maxW, lh){
    ctx.font = `300 ${BIO_PX}px 'Work Sans', sans-serif`;
    ctx.fillStyle = '#fff'; ctx.textBaseline = 'top';
    const paras = String(text||'').split('\n');
    for(const p of paras){
      const words = p.split(' '); let line='';
      for(let i=0;i<words.length;i++){
        const tl = line + words[i] + ' ';
        if(ctx.measureText(tl).width > maxW && i>0){ ctx.fillText(line,x,y); line=words[i]+' '; y+=lh; }
        else { line = tl; }
      }
      ctx.fillText(line, x, y); y += lh;
    }
  }
  function textMaxWidth(){
    const cx = +cxInput.value, r = +crInput.value;
    const rightLimit = (cx - r) - Math.round(30 * (canvas.height/700));
    return Math.max(200, rightLimit - +titleXInput.value);
  }

  function render(){
    const W = canvas.width, H = canvas.height;
    ctx.clearRect(0,0,W,H);
    // 1) Forma base + MasterClass
    drawPill(bgColor.value);
    drawMasterClass();

    // 2) Foto recortada (por cima da forma)
    if(photo){
      const cx=+cxInput.value, cy=+cyInput.value, r=+crInput.value;
      const scale = +scaleInput.value, dx=+posXInput.value, dy=+posYInput.value;
      ctx.save(); ctx.beginPath(); ctx.arc(cx,cy,r-1,0,Math.PI*2); ctx.clip();
      const pw=photo.naturalWidth, ph=photo.naturalHeight;
      const base = Math.max((2*r)/pw,(2*r)/ph) * scale;
      const w=pw*base, h=ph*base;
      ctx.drawImage(photo, cx - w/2 + dx, cy - h/2 + dy, w, h);
      ctx.restore();
    }

    // 3) Título (duas linhas) na âncora do título
    let size = NAME_PX, track = TRACK;
    const nome = (nomeInput.value||'').toUpperCase();
    while (trackedWidth(nome, size, track) > textMaxWidth() && size > 40){
      size -= 1; track = TRACK * (size/NAME_PX);
    }
    const startX = +titleXInput.value, startY = +titleYInput.value;
    drawTracked(nome, startX, startY, size, track);
    drawTracked((sobrenomeInput.value||'').toUpperCase(), startX, startY + size*1.08, size, track);

    // 4) Bio com X/Y independentes
    const maxW = (cxInput.value - crInput.value) - 30 - +bioXInput.value;
    wrap(bioInput.value, +bioXInput.value, +bioYInput.value, Math.max(200,maxW), BIO_LH);

    statusEl.textContent = `${W}×${H}`;
  }

  // Load photo
  photoInput.addEventListener('change', e=>{
    const f=e.target.files?.[0]; if(!f) return;
    if(photoURL) URL.revokeObjectURL(photoURL);
    photoURL = URL.createObjectURL(f);
    const img=new Image(); img.onload=()=>{ photo=img; render(); }; img.src=photoURL;
  });

  // Controls re-render
  [bgColor, mcPos, scaleInput, posXInput, posYInput, cxInput, cyInput, crInput,
   nomeInput, sobrenomeInput, titleXInput, titleYInput, bioInput, bioXInput, bioYInput]
   .forEach(el=>el.addEventListener('input', render));

  // Export
  document.getElementById('export').addEventListener('click', ()=>{
    const a=document.createElement('a');
    const file=`masterclass_${(nomeInput.value+'_'+sobrenomeInput.value).toLowerCase().replace(/[^a-z0-9]+/g,'_')}.png`;
    if(canvas.toBlob){
      canvas.toBlob(b=>{ const url=URL.createObjectURL(b); a.href=url; a.download=file; a.click(); setTimeout(()=>URL.revokeObjectURL(url),1000); }, 'image/png');
    } else { a.href=canvas.toDataURL('image/png'); a.download=file; a.click(); }
  });

  // Initial render
  render();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-PT">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MasterClass – Modelo fiel (título ancorado, 2 linhas + bio)</title>
  <link href="https://fonts.googleapis.com/css2?family=Barlow:wght@800&family=Work+Sans:wght@300;400&display=swap" rel="stylesheet">
  <style>
    html,body{margin:0;background:#0e0e0e;color:#eee;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Work Sans',sans-serif}
    .app{display:grid;grid-template-columns:1fr 400px;gap:20px;max-width:min(1600px,96vw);margin:20px auto}
    .stage{background:#1c1c1c;border-radius:14px;padding:12px;display:flex;align-items:center;justify-content:center}
    canvas{width:100%;height:auto;background:transparent;border-radius:10px}
    .panel{background:#141414;border:1px solid #2a2a2a;border-radius:14px;padding:14px;display:flex;flex-direction:column;gap:12px}
    .row{display:flex;flex-direction:column;gap:6px}
    label{font-size:13px;color:#bbb}
    input[type="text"], textarea{background:#0f0f0f;border:1px solid #333;border-radius:10px;color:#f2f2f2;padding:10px 12px;font-size:14px}
    textarea{min-height:100px;resize:vertical;white-space:pre-wrap}
    input[type="range"]{width:100%}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    button{background:#ff6f4f;border:0;color:#fff;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
    .muted{color:#9aa}
  </style>
</head>
<body>
  <div class="app">
    <div class="stage"><canvas id="c" width="1434" height="700" aria-label="pré‑visualização"></canvas></div>
    <div class="panel">
      <div class="row">
        <label>Carregar MODELO PNG (com “MasterClass” já no sítio)</label>
        <input id="bg" type="file" accept="image/png" />
        <span class="muted">O canvas adapta-se ao tamanho do PNG. O texto começa no X que definires abaixo.</span>
      </div>

      <div class="row">
        <label>Fotografia do especialista</label>
        <input id="photo" type="file" accept="image/*" />
      </div>
      <div class="grid2">
        <div class="row"><label>Escala da foto</label><input id="scale" type="range" min="0.2" max="3" step="0.01" value="1" /></div>
        <div class="row"><label>Posição X</label><input id="posX" type="range" min="-1500" max="1500" step="1" value="0" /></div>
        <div class="row"><label>Posição Y</label><input id="posY" type="range" min="-1500" max="1500" step="1" value="0" /></div>
      </div>

      <div class="row">
        <label>Nome (linha 1)</label>
        <input id="nome" type="text" value="NAIARA" />
      </div>
      <div class="row">
        <label>Sobrenome (linha 2)</label>
        <input id="sobrenome" type="text" value="BACK" />
      </div>

      <div class="row">
        <label>Bio (ENTER = nova linha)</label>
        <textarea id="bio">Formada em Publicidade e Propaganda, com MBA em Marketing Digital e Mestrado em Ciências da Comunicação.</textarea>
      </div>

      <div class="row">
        <label>Âncoras & círculo (afinados ao teu PNG)</label>
        <div class="grid2">
          <div class="row"><label>Início do Título (X)</label><input id="titleX" type="range" min="0" max="2000" step="1" value="110" /></div>
          <div class="row"><label>Topo do Título (Y)</label><input id="titleY" type="range" min="0" max="2000" step="1" value="300" /></div>
          <div class="row"><label>CX círculo</label><input id="cx" type="range" min="0" max="3000" step="1" value="1100" /></div>
          <div class="row"><label>CY círculo</label><input id="cy" type="range" min="0" max="2000" step="1" value="350" /></div>
          <div class="row"><label>R círculo</label><input id="cr" type="range" min="10" max="2000" step="1" value="280" /></div>
        </div>
        <span class="muted">Dica: carrega primeiro o PNG; os sliders passam a ter limites coerentes.</span>
      </div>

      <div class="row">
        <button id="export">Exportar imagem</button>
      </div>
    </div>
  </div>

<script>
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d');

  // UI
  const bgInput = document.getElementById('bg');
  const photoInput = document.getElementById('photo');
  const scaleInput = document.getElementById('scale');
  const posXInput = document.getElementById('posX');
  const posYInput = document.getElementById('posY');

  const nomeInput = document.getElementById('nome');
  const sobrenomeInput = document.getElementById('sobrenome');
  const bioInput = document.getElementById('bio');

  const titleXInput = document.getElementById('titleX');
  const titleYInput = document.getElementById('titleY');
  const cxInput = document.getElementById('cx');
  const cyInput = document.getElementById('cy');
  const crInput = document.getElementById('cr');

  const exportBtn = document.getElementById('export');

  // Imagens
  let bgImg = null;
  let photo = null; let photoURL = null;

  // Tipografia
  const pt = v => v * (96/72);
  let NAME_PX_BASE = pt(208.11); // reescalado ao png
  let BIO_PX = pt(20.8);
  let TRACKING = pt(6); // espaçamento amplo

  function rescaleToPNG(){
    if(!bgImg) return;
    canvas.width = bgImg.naturalWidth;
    canvas.height = bgImg.naturalHeight;
    const s = canvas.height / 700;
    NAME_PX_BASE = pt(208.11) * s;
    BIO_PX = pt(20.8) * s;
    TRACKING = pt(6) * s;

    // Limites dos sliders coerentes
    [titleXInput, cxInput].forEach(el => { el.max = String(canvas.width); });
    [titleYInput, cyInput, crInput].forEach(el => { el.max = String(canvas.height); });

    // Defaults aproximados (como o teu mockup)
    titleXInput.value = Math.round(110 * s);
    titleYInput.value = Math.round(300 * s);
    cxInput.value = Math.round(canvas.width * 0.78);
    cyInput.value = Math.round(canvas.height * 0.50);
    crInput.value = Math.round(canvas.height * 0.43);

    posXInput.min = -canvas.width; posXInput.max = canvas.width;
    posYInput.min = -canvas.height; posYInput.max = canvas.height;
  }

  function drawTracked(text, x, y, sizePx, trackingPx){
    ctx.font = `800 ${sizePx}px 'Barlow', sans-serif`;
    ctx.fillStyle = '#fff'; ctx.textBaseline = 'alphabetic';
    let cursor = x;
    for(const ch of (text||'')){
      const m = ctx.measureText(ch);
      ctx.fillText(ch, cursor, y);
      cursor += m.width + trackingPx;
    }
  }
  function trackedWidth(text, sizePx, trackingPx){
    ctx.font = `800 ${sizePx}px 'Barlow', sans-serif`;
    let w=0; for(const ch of (text||'')){ w += ctx.measureText(ch).width + trackingPx; } return w;
  }

  function wrap(text, x, y, maxW, lh){
    ctx.font = `300 ${BIO_PX}px 'Work Sans', sans-serif`;
    ctx.fillStyle = '#fff'; ctx.textBaseline = 'top';
    const paras = String(text||'').split('\n');
    for(const p of paras){
      const words = p.split(' '); let line='';
      for(let i=0;i<words.length;i++){
        const tl = line + words[i] + ' ';
        if(ctx.measureText(tl).width > maxW && i>0){ ctx.fillText(line,x,y); line=words[i]+' '; y+=lh; }
        else { line = tl; }
      }
      ctx.fillText(line, x, y); y += lh;
    }
  }

  function textMaxWidth(){
    const cx = +cxInput.value, r = +crInput.value;
    const rightLimit = (cx - r) - Math.round(30 * (canvas.height/700));
    return Math.max(200, rightLimit - +titleXInput.value);
  }

  function render(){
    const W = canvas.width, H = canvas.height;
    ctx.clearRect(0,0,W,H);

    // 1) Layout
    if(bgImg) ctx.drawImage(bgImg,0,0,W,H);

    // 2) Foto (recorte circular) por cima
    if(photo){
      const cx=+cxInput.value, cy=+cyInput.value, r=+crInput.value;
      const scale = +scaleInput.value, dx=+posXInput.value, dy=+posYInput.value;
      ctx.save(); ctx.beginPath(); ctx.arc(cx,cy,r-1,0,Math.PI*2); ctx.clip();
      const pw=photo.naturalWidth, ph=photo.naturalHeight;
      const base = Math.max((2*r)/pw,(2*r)/ph) * scale;
      const w=pw*base, h=ph*base;
      ctx.drawImage(photo, cx - w/2 + dx, cy - h/2 + dy, w, h);
      ctx.restore();
    }

    // 3) Título em duas linhas (nome e sobrenome) a partir da âncora X/Y
    const startX = +titleXInput.value;
    const baseY  = +titleYInput.value;
    const nome = (nomeInput.value||'').toUpperCase();
    const sobrenome = (sobrenomeInput.value||'').toUpperCase();

    // Reduz até caber na largura útil
    let size = NAME_PX_BASE, track = TRACKING;
    while (trackedWidth(nome, size, track) > textMaxWidth() && size > 40){
      size -= 1; track = TRACKING * (size/NAME_PX_BASE);
    }
    // Linha 1
    drawTracked(nome, startX, baseY, size, track);
    // Linha 2 (mesma largura alvo, mesmo tamanho)
    drawTracked(sobrenome, startX, baseY + size*1.08, size, track);

    // 4) Bio por baixo
    const bioTop = baseY + size*1.08 + size*0.45;
    wrap(bioInput.value, startX, bioTop, textMaxWidth(), Math.round(BIO_PX*1.45));
  }

  // Eventos
  bgInput.addEventListener('change', e=>{
    const f=e.target.files?.[0]; if(!f) return;
    const url=URL.createObjectURL(f); const img=new Image();
    img.onload=()=>{ bgImg=img; rescaleToPNG(); render(); };
    img.src=url;
  });
  photoInput.addEventListener('change', e=>{
    const f=e.target.files?.[0]; if(!f) return;
    if(photoURL) URL.revokeObjectURL(photoURL);
    photoURL = URL.createObjectURL(f);
    const img=new Image(); img.onload=()=>{ photo=img; render(); }; img.src=photoURL;
  });
  [scaleInput,posXInput,posYInput,nomeInput,sobrenomeInput,bioInput,
   titleXInput,titleYInput,cxInput,cyInput,crInput].forEach(el=>el.addEventListener('input', render));

  exportBtn.addEventListener('click', ()=>{
    if(!bgImg){ alert('Carrega primeiro o MODELO PNG.'); return; }
    const a=document.createElement('a');
    const file=`masterclass_${(nomeInput.value+'_'+sobrenomeInput.value).toLowerCase().replace(/[^a-z0-9]+/g,'_')}.png`;
    if(canvas.toBlob){
      canvas.toBlob(b=>{ const url=URL.createObjectURL(b); a.href=url; a.download=file; a.click(); setTimeout(()=>URL.revokeObjectURL(url),1000); }, 'image/png');
    } else { a.href=canvas.toDataURL('image/png'); a.download=file; a.click(); }
  });

  // Render inicial
  render();
</script>
</body>
</html>
